name: Build and Deploy Standalone Bundle

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - 'vite.config.standalone.ts'
      - 'package.json'
      - '.github/workflows/standalone.yml'
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-deploy-standalone:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build standalone bundle
        run: npm run build:standalone

      - name: Create standalone branch
        run: |
          git checkout --orphan standalone || git checkout standalone
          git reset --hard

      - name: Copy standalone files
        run: |
          cp dist/specula.js .
          cp dist/specula.css .
          # Create a simple index.html example
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Specula Standalone Example</title>
              <style>
                  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
                  #specula-container { width: 100%; height: 100vh; }
              </style>
              <link rel="stylesheet" href="./specula.css">
          </head>
          <body>
              <div id="specula-container"></div>
              <script src="./specula.js"></script>
              <script>
                  Specula.init({
                      container: '#specula-container',
                      openapi: 'https://petstore3.swagger.io/api/v3/openapi.json'
                  }).catch(function(error) {
                      console.error('Failed to initialize Specula:', error);
                  });
              </script>
          </body>
          </html>
          EOF
          # Create README for standalone branch
          cat > README.md << 'EOF'
          # Specula Standalone Bundle

          This branch contains the standalone bundle files for easy integration.

          ## Quick Start

          Include Specula in your HTML page using jsDelivr CDN:

          ```html
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>My API Documentation</title>
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/quonaro/Specula@standalone/specula.css">
              <style>
                  #specula-container { width: 100%; height: 100vh; }
              </style>
          </head>
          <body>
              <div id="specula-container"></div>
              <script src="https://cdn.jsdelivr.net/gh/quonaro/Specula@standalone/specula.js"></script>
              <script>
                  Specula.init({
                      container: '#specula-container',
                      openapi: 'https://api.example.com/openapi.json'
                  });
              </script>
          </body>
          </html>
          ```

          Replace `quonaro/Specula` with your repository path if you fork the project.

          ## Files

          - `specula.js` - Main JavaScript bundle (~387 KB)
          - `specula.css` - CSS styles (~44 KB)
          - `index.html` - Example usage

          ## Configuration

          The `Specula.init()` function accepts:
          - `container` (required): CSS selector or HTMLElement where Specula will be rendered
          - `openapi` (required): URL or array of URLs to OpenAPI specifications

          For more details, see the main repository documentation.
          EOF

      - name: Commit and push to standalone branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add specula.js specula.css index.html README.md
          git commit -m "Update standalone bundle [skip ci]" || exit 0
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git standalone --force

